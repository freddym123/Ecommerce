{% extends 'main.html' %}
{% load static %}
{% load icons %}

{% block content %}
<main class="responsive-container">
    <h2>Shopping Cart</h2>
    

    {% if cart_products %}
        <div class="cart-page-grid">
            <div>PRODUCT</div>
            <div>PRICE</div>
            <div>QTY</div>
            <div>SUBTOTAL</div>
        </div>
        <div class="cart-page-items-grid">
            {% for product in cart_products %}
                <div class="cart-item">
                    <div><img src="{{product.image.url}}"></div>
                    <div>
                        <p>{{product.name}}</p>
                        <p>(Size: S, Color: Red)</p>
                    </div>
                </div>

                <div>${{product.price}}</div>

                <div class="btn-increase">
                    <button class="dec-item" data-index="{{product.id}}">-</button>
                    <div id="qty{{product.id}}">
                        {% for key, value in quantities.items %}
                            {% if key == product.id|slugify %}
                                {{value}}
                            {% endif %}
                        {% endfor %}
                    </div>
                    <button class="inc-item" data-index="{{product.id}}">+</button>
                </div>
                
                <div>
                    {% for key, value in items_total.items %}
                        {% if key|slugify == product.id|slugify %}
                            ${{value}}
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="delete-item" data-index="{{product.id}}">{% icon 'trash' %}</div>
            {% endfor %}
            
        </div>



        <div class="cart-part-price-grid">
            <div>Sub total</div>
            <div>${{totals}}</div>
            <div>Tax</div>
            <div>${{tax}}</div>
            <div>Total<p>(Shipping fees not included)</p></div>
            <div>${{subtotal}}</div>
        </div>

        <a href="{% url 'checkout' %}"><button class="cart-page-checkout">CHECKOUT</button></a>
    {% else %}
        <p>No items in cart</p>
    {% endif %}
</main>

<script>
    $(document).on('click', '.inc-item', function(e){
        e.preventDefault()

        var productid = $(this).data('index')
        let qty = parseInt($('#qty' + productid).text())
        if(qty > 9){
            return
        } 
        qty += 1
        $("#qty" + productid).text(qty)

        $.ajax({
            type: 'POST',
            url: "{% url  'cart_update' %}",
            data: {
                product_id: productid,
                product_qty: $("#qty" + productid).text(),
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: "post"
            },

            success: function(json){
                location.reload()
            }

        })
    })

    $(document).on('click', '.dec-item', function(e){
        e.preventDefault()

        var productid = $(this).data('index')
        let qty = parseInt($('#qty' + productid).text())
        if(qty < 2){
            return
        } 
        qty -= 1
        $("#qty" + productid).text(qty)

        $.ajax({
            type: 'POST',
            url: "{% url  'cart_update' %}",
            data: {
                product_id: productid,
                product_qty: $("#qty" + productid).text(),
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: "post"
            },

            success: function(json){
                location.reload()
            }

        })
    })

    $(document).on('click', '.delete-item', function(e){
        e.preventDefault()

        $.ajax({
            type: 'POST',
            url: "{% url  'cart_delete' %}",
            data: {
                product_id: $(this).data('index'),
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: "post"
            },
            success: function(json){
                location.reload()
            }

        }
    )
    })

    
</script>
{% endblock %}